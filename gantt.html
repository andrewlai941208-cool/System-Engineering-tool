<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Diagram</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... 您所有的 CSS 樣式 (與您提供的一致) ... */
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .card { box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); }
        .gantt-chart-container { display: grid; grid-template-columns: 280px 1fr; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; background-color: white; min-height: 400px; }
        .task-list { padding: 0.5rem; border-right: 1px solid #e5e7eb; overflow-y: hidden; padding-top: 40px; position: relative; }
        .gantt-area { overflow: auto; }
        .time-axis { display: flex; position: sticky; top: 0; background-color: #f3f4f6; border-bottom: 1px solid #e5e7eb; z-index: 10; height: 40px; align-items: center; }
        .task-row { height: 40px; display: flex; align-items: center; border-bottom: 1px solid #e5e7eb; }
        .task-bar { position: absolute; height: 30px; border-radius: 0.25rem; cursor: grab; transition: background-color 0.1s; z-index: 5; padding-left: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-bar:hover { opacity: 0.9; }
        .task-bar:active { cursor: grabbing; }
        .day-cell { min-width: 30px; text-align: center; font-size: 0.75rem; border-right: 1px solid #f3f4f6; height: 100%; display: flex; align-items: center; justify-content: center; }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; font-size: 1.25rem; color: #4f46e5; z-index: 100; border-radius: 0.5rem; }
        .modal { transition: opacity 0.3s ease-in-out; pointer-events: none; opacity: 0; }
        .modal.open { pointer-events: auto; opacity: 1; }
        .gantt-grid-lines { background-size: 100% 40px; background-image: repeating-linear-gradient( to bottom, transparent 0px, transparent 39px, #e5e7eb 39px, #e5e7eb 40px ); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 relative">
            <h1 id="projectTitle" class="text-4xl font-bold text-gray-800 mb-2"></h1> 
            <div class="absolute top-0 left-0">
                 <a href="/projects" class="text-indigo-600 hover:text-indigo-800">&larr; 返回專案列表</a>
            </div>
            <div class="absolute top-0 right-0">
                <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    登出
                </button>
            </div>
        </header>

        <div id="addTaskForm" class="bg-white p-6 rounded-xl mb-6 card grid grid-cols-1 sm:grid-cols-2 md:grid-cols-7 gap-4 border border-gray-200">
            <input type="text" id="taskName" placeholder="任務名稱" class="col-span-1 md:col-span-2 p-2 border rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            <input type="date" id="taskStart" class="p-2 border rounded-md">
            <input type="number" id="taskDuration" placeholder="持續天數" value="5" min="1" class="p-2 border rounded-md">
            <select id="taskPriority" class="p-2 border rounded-md">
                <option value="1">P1 (最高)</option>
                <option value="2">P2</option>
                <option value="3" selected>P3</option>
                <option value="4">P4</option>
                <option value="5">P5 (最低)</option>
            </select>
            <button onclick="addTask()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 md:col-span-2">
                新增任務
            </button>
        </div>
        
        <main class="card bg-white rounded-xl p-0 overflow-hidden relative">
            <div id="loadingOverlay" class="loading-overlay">
                <p>正在從後端伺服器載入數據...</p>
            </div>
            <div id="ganttChart" class="gantt-chart-container">
            </div>
        </main>
        
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>本應用程式由 Go 後端提供數據服務，數據持久化於 CockroachDB。</p>
            <p id="statusMessage" class="mt-2 text-sm font-semibold text-blue-600">載入中...</p>
        </footer>
    </div>

    <div id="editModal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="bg-white p-6 rounded-lg w-full max-w-md shadow-2xl transform scale-100">
            <h2 class="text-2xl font-bold mb-4">編輯任務：<span id="edit-task-title"></span></h2>
            <form id="editForm" onsubmit="event.preventDefault(); updateTask()">
                <input type="hidden" id="edit-id">
                <div class="mb-4">
                    <label for="edit-name" class="block text-sm font-medium text-gray-700">任務名稱</label>
                    <input type="text" id="edit-name" required class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                </div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-priority" class="block text-sm font-medium text-gray-700">優先度</label>
                        <select id="edit-priority" required class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                            <option value="1">P1 (最高)</option>
                            <option value="2">P2</option>
                            <option value="3">P3</option>
                            <option value="4">P4</option>
                            <option value="5">P5 (最低)</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-duration" class="block text-sm font-medium text-gray-700">持續天數</label>
                        <input type="number" id="edit-duration" min="1" required class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="mb-4 grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-start" class="block text-sm font-medium text-gray-700">起始日期</label>
                        <input type="date" id="edit-start" required class="mt-1 p-2 block w-full border border-gray-300 rounded-md">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">取消</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
   <script>
    // --- 1. 數據模型與 API 設置 ---
    const DAY_WIDTH = 30;
    
    const token = localStorage.getItem('authToken');
    const urlParams = new URLSearchParams(window.location.search);
    const currentProjectId = urlParams.get('project_id');

    let API_ENDPOINT = ''; 
    
    let tasks = []; 
    let nextTaskId = 1;
    
    const statusMessage = document.getElementById('statusMessage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const editModal = document.getElementById('editModal');
    
    const PRIORITY_COLORS = {
        1: '#EF4444', 2: '#F97316', 3: '#F59E0B', 4: '#10B981', 5: '#6B7280',
    };

    function getPriorityColor(priority) {
        return PRIORITY_COLORS[priority] || '#9CA3AF';
    }

    function formatDate(date) {
        return date.getFullYear() + '-' + 
                String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                String(date.getDate()).padStart(2, '0');
    }

    function logout() {
        localStorage.removeItem('authToken');
        localStorage.removeItem('isAdmin'); // 確保清空 admin 狀態
        window.location.href = '/'; 
    }

    // 帶有認證的 fetch 輔助函數 (關鍵)
    async function fetchWithAuth(url, options = {}) {
        if (!token) {
            logout();
            return;
        }

        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };
        
        if (options.body && !(options.body instanceof FormData)) {
            headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            logout();
            throw new Error('Unauthorized/Session Expired');
        }
        
        return response;
    }


    // --- 2. API 互動函數 ---

    function reIndexTasks() {
        tasks = tasks.map((task, index) => ({
            ...task,
            id: index + 1 
        }));
        nextTaskId = tasks.length + 1;
    }

    async function fetchTasks() {
        loadingOverlay.style.display = 'flex';
        statusMessage.textContent = 'Requesting task data...';
        try {
            const response = await fetchWithAuth(API_ENDPOINT); 
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || response.statusText);
            }
            const fetchedTasks = await response.json();
            
            // *** 這裡不再設定標題，標題由 window.onload 處理 ***
            
            tasks = fetchedTasks.map(t => ({
                id: t.id,
                name: t.name,
                start: t.start,
                durationDays: t.durationDays,
                color: getPriorityColor(t.priority),
                priority: t.priority
            }));
            
            nextTaskId = tasks.length > 0 ? Math.max(...tasks.map(t => t.id)) + 1 : 1;

            statusMessage.textContent = "Data synced successfully. Total " + tasks.length + " tasks.";
            renderGantt();
        } catch (error) {
            console.error("Failed to load tasks:", error);
            statusMessage.textContent = "載入任務失敗: " + error.message;
        } finally {
            loadingOverlay.style.display = 'none';
        }
    }

    async function saveTasksToBackend() {
        reIndexTasks();
        const tasksToSend = tasks.map(t => ({
            id: t.id, name: t.name, start: t.start, durationDays: t.durationDays, priority: t.priority
        }));

        try {
            const response = await fetchWithAuth(API_ENDPOINT, {
                method: 'POST',
                body: JSON.stringify(tasksToSend)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Backend save failed');
            }
            statusMessage.textContent = 'Tasks successfully saved.';
            renderGantt(); 
        } catch (error) {
            console.error("Failed to save tasks:", error);
            statusMessage.textContent = "儲存失敗: " + error.message;
            throw error; 
        }
    }
    
    // --- 3. 日期工具函數 ---
    function dateDiffInDays(a, b) {
        const _MS_PER_DAY = 1000 * 60 * 60 * 24;
        const utc1 = Date.UTC(a.getFullYear(), a.getMonth(), a.getDate());
        const utc2 = Date.UTC(b.getFullYear(), b.getMonth(), b.getDate());
        return Math.floor((utc2 - utc1) / _MS_PER_DAY);
    }

    function getPriorityLabel(p) {
        return "P" + p;
    }

    function calculateDateRange() {
        if (tasks.length === 0) {
             const today = new Date();
             const future = new Date(today);
             future.setDate(today.getDate() + 30);
             return { minDate: today, maxDate: future };
        }
        let minDate = new Date(tasks[0].start);
        let maxDate = new Date(tasks[0].start);

        tasks.forEach(task => {
            const start = new Date(task.start);
            const end = new Date(start);
            end.setDate(end.getDate() + task.durationDays - 1); 
            if (start < minDate) minDate = start;
            if (end > maxDate) maxDate = end;
        });
        minDate.setDate(minDate.getDate() - 7);
        maxDate.setDate(maxDate.getDate() + 7);
        return { minDate, maxDate };
    }


    // --- 4. 渲染函數 ---

    function renderGantt() {
        const chartElement = document.getElementById('ganttChart');
        chartElement.innerHTML = '';
        
        if (tasks.length === 0) {
            chartElement.textContent = '目前沒有任務。請新增一個任務開始規劃！';
            chartElement.classList.add('flex', 'justify-center', 'items-center');
            return;
        } else {
            chartElement.classList.remove('flex', 'justify-center', 'items-center');
        }

        const { minDate, maxDate } = calculateDateRange();
        const totalDays = dateDiffInDays(minDate, maxDate) + 1;
        const chartWidth = totalDays * DAY_WIDTH;

        const taskList = document.createElement('div');
        taskList.className = 'task-list';
        taskList.style.height = tasks.length * 40 + 40 + "px";
        
        const taskListHeader = document.createElement('div');
        taskListHeader.className = 'task-row font-bold text-gray-700 bg-gray-50 border-b border-gray-200 items-center px-2 text-sm absolute top-0 left-0 w-full z-20';
        taskListHeader.innerHTML = '<div class="w-1/12">ID</div><div class="w-7/12">任務名稱 (優先度)</div><div class="w-4/12 text-center"></div>';
        taskList.appendChild(taskListHeader);

        tasks.forEach((task, index) => {
            const taskNameElement = document.createElement('div');
            taskNameElement.className = 'task-row text-sm items-center px-2';
            taskNameElement.innerHTML = `
                <div class="w-1/12 text-gray-400">#${task.id}</div> 
                <div class="w-7/12 truncate">${task.name} (${getPriorityLabel(task.priority)})</div>
                <div class="w-4/12 flex justify-center space-x-1">
                    <button onclick="moveTaskUp(${index})" class="text-gray-500 hover:text-blue-600 p-1 rounded-full leading-none transition duration-150" title="上移">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg>
                    </button>
                    <button onclick="moveTaskDown(${index})" class="text-gray-500 hover:text-blue-600 p-1 rounded-full leading-none transition duration-150" title="下移">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <button onclick="editTask(${task.id})" class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full leading-none transition duration-150" title="編輯任務">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                    </button>
                    <button onclick="deleteTask(${task.id})" class="text-red-500 hover:text-red-700 p-1 rounded-full leading-none transition duration-150" title="刪除任務">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            `;
            taskList.appendChild(taskNameElement);
        });
        chartElement.appendChild(taskList);

        const ganttArea = document.createElement('div');
        ganttArea.className = 'gantt-area';

        const timeAxis = document.createElement('div');
        timeAxis.className = 'time-axis';
        timeAxis.style.width = chartWidth + "px";
        timeAxis.style.minWidth = "100%";
        
        const currentDay = new Date(minDate);
        while (currentDay <= maxDate) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell';
            dayCell.textContent = currentDay.getDate(); 
            if (currentDay.getDate() === 1 || dateDiffInDays(minDate, currentDay) === 0) {
                dayCell.textContent = (currentDay.getMonth() + 1) + "/" + currentDay.getDate();
                dayCell.classList.add('font-bold', 'text-xs', 'bg-gray-200');
            }
            timeAxis.appendChild(dayCell);
            currentDay.setDate(currentDay.getDate() + 1);
        }
        ganttArea.appendChild(timeAxis);

        const taskBarsContainer = document.createElement('div');
        taskBarsContainer.className = 'gantt-grid-lines';
        taskBarsContainer.style.width = chartWidth + "px";
        taskBarsContainer.style.position = 'relative'; 
        taskBarsContainer.style.minWidth = "100%";
        taskBarsContainer.style.height = tasks.length * 40 + "px"; 

        tasks.forEach((task, index) => { 
            const startDayIndex = dateDiffInDays(minDate, new Date(task.start));
            const leftPosition = startDayIndex * DAY_WIDTH;
            const width = task.durationDays * DAY_WIDTH;

            const bar = document.createElement('div');
            bar.id = "task-" + task.id;
            bar.className = 'task-bar text-xs flex items-center justify-start text-white font-semibold shadow-md';
            bar.style.backgroundColor = task.color;
            bar.style.width = width + "px";
            bar.style.left = leftPosition + "px";
            bar.style.top = (index * 40 + 5) + "px"; 
            bar.setAttribute('data-task-id', task.id); 
            bar.setAttribute('data-start-day', startDayIndex); 
            bar.textContent = task.name + " (" + task.durationDays + " days)";

            addDragListeners(bar, task);
            taskBarsContainer.appendChild(bar);
        });
        ganttArea.appendChild(taskBarsContainer);
        chartElement.appendChild(ganttArea);

        ganttArea.addEventListener('scroll', () => {
            const taskListScroll = document.querySelector('.task-list');
            taskListScroll.scrollTop = ganttArea.scrollTop;
        });
    }

    // ... (其餘互動邏輯保持不變) ...
    
    window.moveTaskUp = async function(index) { 
        if (index === 0) return;
        [tasks[index], tasks[index - 1]] = [tasks[index - 1], tasks[index]];
        statusMessage.textContent = `正在移動任務...`;
        try {
            await saveTasksToBackend();
            statusMessage.textContent = `任務順序已儲存。`;
        } catch (error) {
            statusMessage.textContent = `順序儲存失敗: ${error.message}`;
            [tasks[index], tasks[index - 1]] = [tasks[index - 1], tasks[index]];
        }
    }
    
    window.moveTaskDown = async function(index) { 
        if (index >= tasks.length - 1) return;
        [tasks[index], tasks[index + 1]] = [tasks[index + 1], tasks[index]];
        statusMessage.textContent = `正在移動任務...`;
        try {
            await saveTasksToBackend();
            statusMessage.textContent = `任務順序已儲存。`;
        } catch (error) {
            statusMessage.textContent = `順序儲存失敗: ${error.message}`;
            [tasks[index], tasks[index + 1]] = [tasks[index + 1], tasks[index]];
        }
    }
    
    let isDragging = false;
    let dragTask = null;
    let dragStartX = 0;
    let initialLeft = 0;
    
    function addDragListeners(bar, task) {
        bar.addEventListener('mousedown', (e) => {
            e.preventDefault(); 
            isDragging = true;
            dragTask = tasks.find(t => t.id === task.id); 
            dragStartX = e.clientX;
            initialLeft = bar.offsetLeft;
            bar.classList.add('shadow-xl', 'scale-105', 'z-20');
            bar.style.opacity = '0.8';
            statusMessage.textContent = "開始拖曳: " + task.name;
        });
    }

    document.addEventListener('mousemove', (e) => {
        if (!isDragging || !dragTask) return;
        const barElement = document.getElementById("task-" + dragTask.id);
        if (!barElement) return;

        const deltaX = e.clientX - dragStartX;
        let newLeft = initialLeft + deltaX;
        const snappedDayOffset = Math.round(newLeft / DAY_WIDTH);
        const snappedLeft = snappedDayOffset * DAY_WIDTH;

        barElement.style.left = snappedLeft + "px";
        
        const { minDate } = calculateDateRange();
        const potentialNewStartDate = new Date(minDate);
        potentialNewStartDate.setDate(minDate.getDate() + snappedDayOffset);

        statusMessage.textContent = "拖曳中 " + dragTask.name + "... 新日期: " + formatDate(potentialNewStartDate);
    });

    document.addEventListener('mouseup', () => {
        if (!isDragging || !dragTask) return;
        const barElement = document.getElementById("task-" + dragTask.id);
        if (!barElement) return;

        isDragging = false;
        const finalLeft = barElement.offsetLeft;
        const finalDayOffset = Math.round(finalLeft / DAY_WIDTH);
        const { minDate } = calculateDateRange();
        const newStartDate = new Date(minDate);
        newStartDate.setDate(minDate.getDate() + finalDayOffset);

        dragTask.start = formatDate(newStartDate);
        statusMessage.textContent = "任務 " + dragTask.name + " 已更新。新起始日期: " + dragTask.start + ", 正在儲存...";
        
        saveTasksToBackend(); 

        barElement.classList.remove('shadow-xl', 'scale-105', 'z-20');
        barElement.style.opacity = '1';
        dragTask = null;
    });

    window.editTask = function(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        document.getElementById('edit-id').value = task.id;
        document.getElementById('edit-task-title').textContent = task.name;
        document.getElementById('edit-name').value = task.name;
        document.getElementById('edit-priority').value = task.priority;
        document.getElementById('edit-duration').value = task.durationDays;
        document.getElementById('edit-start').value = task.start;

        editModal.classList.add('open');
    }

    window.closeEditModal = function() {
        editModal.classList.remove('open');
    }

    window.updateTask = function() {
        const taskId = parseInt(document.getElementById('edit-id').value);
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex === -1) {
            closeEditModal();
            statusMessage.textContent = '錯誤：找不到任務。';
            return;
        }

        const newPriority = parseInt(document.getElementById('edit-priority').value);
        
        tasks[taskIndex].name = document.getElementById('edit-name').value;
        tasks[taskIndex].priority = newPriority;
        tasks[taskIndex].durationDays = parseInt(document.getElementById('edit-duration').value);
        tasks[taskIndex].start = document.getElementById('edit-start').value;
        tasks[taskIndex].color = getPriorityColor(newPriority); 

        closeEditModal();
        statusMessage.textContent = '任務 ID ' + taskId + ' 已更新，正在儲存...';
        saveTasksToBackend(); 
    }

    window.addTask = function() {
        const name = document.getElementById('taskName').value;
        const start = document.getElementById('taskStart').value;
        const duration = parseInt(document.getElementById('taskDuration').value);
        const priority = parseInt(document.getElementById('taskPriority').value);
        const color = getPriorityColor(priority); 

        if (!name || !start || isNaN(duration) || isNaN(priority) || duration <= 0 || priority < 1 || priority > 5) {
            statusMessage.textContent = '錯誤：請輸入有效的任務名稱、起始日期、持續天數 (>0) 和優先度 (P1-P5)。';
            statusMessage.classList.replace('text-blue-600', 'text-red-600');
            return;
        }
        statusMessage.classList.replace('text-red-600', 'text-blue-600');

        const newTask = {
            id: nextTaskId++, 
            name: name,
            start: start,
            durationDays: duration,
            color: color,
            priority: priority,
        };

        tasks.push(newTask);
        statusMessage.textContent = "成功新增任務: " + name + " (優先度 P" + priority + ")，正在儲存...";

        saveTasksToBackend(); 

        document.getElementById('taskName').value = '';
        document.getElementById('taskDuration').value = 5;
        document.getElementById('taskStart').value = formatDate(new Date()); 
    }
    
    
    // --- 7. 啟動應用程式 ---
    
    window.onload = async () => {
        // 檢查登入和專案 ID
        if (!token) {
            logout();
            return;
        }
        if (!currentProjectId) {
            alert('未指定專案 ID！');
            window.location.href = '/projects';
            return;
        }
        
        // 設置動態 API 端點 (用於 Tasks)
        API_ENDPOINT = `/api/projects/${currentProjectId}/tasks`;
        
        // 1. 先嘗試取得專案名稱
        const projectTitleElement = document.getElementById('projectTitle');
        projectTitleElement.textContent = `載入中...`; // 暫時設置載入狀態
        
        try {
            const projectResponse = await fetchWithAuth(`/api/projects/${currentProjectId}`);
            
            if (!projectResponse.ok) {
                // 處理 404/500 等錯誤
                const errorData = await projectResponse.json();
                console.error("無法取得專案資訊:", errorData.error || projectResponse.statusText);
                
                // *** 修正: 如果 API 失敗，讓標題顯示錯誤狀態 ***
                projectTitleElement.textContent = `錯誤：找不到專案 #${currentProjectId}`; 
            } else {
                const projectData = await projectResponse.json();
                // 成功取得資料，更新標題
                projectTitleElement.textContent = `${projectData.name} - 甘特圖`; 
            }
        } catch (error) {
             // 處理網路連線失敗，或 JSON 解析失敗
             console.error("取得專案資訊時發生錯誤:", error);
             projectTitleElement.textContent = `載入專案名稱失敗`;
        }

        // 初始化表單日期
        document.getElementById('taskStart').value = formatDate(new Date());

        // 3. 接著載入任務
        await fetchTasks();
    };
</script>
</body>
</html>